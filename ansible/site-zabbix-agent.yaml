---
- name: Install Zabbix Agent
  hosts: 
    - web_servers
    - bastion_server
    - elasticsearch_server
    - kibana_server
  become: true
  
  tasks:   
    - name: Add Zabbix repository
      apt:
        deb: "https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_6.0+ubuntu22.04_all.deb"        
        state: present 
        
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Zabbx agent
      apt:
        name:
          - zabbix-agent          
        state: present 

    - name: Configure Zabbix Agent
      template:
        src: templates/zabbix_agent.conf.j2
        dest: //etc/zabbix/zabbix_agentd.conf
      notify: restart zabbix-agent
    
    - name: Start and enable Zabbix Agent
      service:
        name: zabbix-agent
        state: started
        enabled: yes

  handlers:
    - name: restart zabbix-agent
      service:
        name: zabbix-agent
        state: restarted